<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px;color:#222}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px;min-width:200px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
    fieldset{border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:12px}
    legend{font-weight:600}
    .hidden{display:none}
    .muted{color:#666;font-size:13px}
    #msg{margin-top:10px}
    .inline{width:auto;display:inline-block}
    .small{width:120px;padding:6px}
    .tokenBox{background:#f7f7f7;border:1px dashed #ccc;padding:12px;border-radius:6px;word-break:break-all}
    .error{color:#b00020}
    .ok{color:#0b6f00}
  </style>
</head>
<body>
  <h2>Create account</h2>

  <form id="registerForm" autocomplete="on" novalidate>
    <fieldset>
      <legend>Account (required)</legend>
      <div class="row">
        <div class="col">
          <label for="username">Username</label>
          <input id="username" name="username" type="text" maxlength="50" required placeholder="letters, numbers, _ . -"/>
        </div>
        <div class="col">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" maxlength="191" required placeholder="you@example.com"/>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" minlength="8" required placeholder="Minimum 8 characters" />
        </div>

        <div class="col">
          <label for="role_key">Account type</label>
          <select id="role_key" name="role_key" required>
            <option value="customer">Customer</option>
            <option value="vendor">Vendor</option>
            <option value="home_vendor">Home Vendor</option>
            <option value="third_party_service">Third Party Service</option>
            <option value="guest">Guest</option>
          </select>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>User Profile</legend>
      <div class="row">
        <div class="col">
          <label for="phone">Phone (E.164, include country code)</label>
          <input id="phone" name="phone" type="tel" maxlength="45" required placeholder="+9715..." />
        </div>
        <div class="col">
          <label for="preferred_language">Preferred language</label>
          <select id="preferred_language" name="preferred_language">
            <option value="">(select)</option>
            <option value="en">English</option>
            <option value="ar">Arabic</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="country_id">Country</label>
          <select id="country_id" name="country_id" required>
            <option value="">Loading countries...</option>
          </select>
        </div>
        <div class="col">
          <label for="city_id">City</label>
          <select id="city_id" name="city_id">
            <option value="">Select country first</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <label for="timezone">Timezone</label>
          <input id="timezone" name="timezone" type="text" placeholder="e.g. Asia/Dubai" />
        </div>
        <div class="col">
          <label for="postal_code">Postal code</label>
          <input id="postal_code" name="postal_code" type="text" maxlength="32" />
        </div>
      </div>
    </fieldset>

    <fieldset id="storeSection" class="hidden">
      <legend>Store details (for Vendor / Home Vendor / Third Party)</legend>

      <div style="margin-bottom:8px">
        <label><input type="checkbox" id="store_use_account" name="store_use_account" /> Use account contact for the store</label>
      </div>

      <div class="row">
        <div class="col">
          <label for="store_name">Store name</label>
          <input id="store_name" name="store_name" type="text" maxlength="255" placeholder="My Store" />
        </div>
        <div class="col">
          <label for="store_email">Store email</label>
          <input id="store_email" name="store_email" type="email" maxlength="191" placeholder="store@example.com" />
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="store_phone">Store phone</label>
          <input id="store_phone" name="store_phone" type="tel" maxlength="45" placeholder="+971..." />
        </div>
        <div class="col">
          <label for="store_country_id">Store country</label>
          <select id="store_country_id" name="store_country_id">
            <option value="">(select)</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px">
        <label for="store_street_address">Street address</label>
        <textarea id="store_street_address" name="store_street_address" rows="2"></textarea>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="store_postal_code">Postal code</label>
          <input id="store_postal_code" name="store_postal_code" type="text" maxlength="32" />
        </div>
        <div class="col">
          <label for="store_state">State / Region</label>
          <input id="store_state" name="store_state" type="text" maxlength="255" />
        </div>
      </div>

      <div style="margin-top:8px">
        <label for="store_latitude">Store latitude (optional)</label>
        <input id="store_latitude" name="store_latitude" type="text" placeholder="e.g. 25.2048" />
      </div>
      <div style="margin-top:8px">
        <label for="store_longitude">Store longitude (optional)</label>
        <input id="store_longitude" name="store_longitude" type="text" placeholder="e.g. 55.2708" />
      </div>

      <div style="margin-top:8px">
        <label><input type="checkbox" id="create_store" name="create_store" value="1" /> Create store now</label>
      </div>
    </fieldset>

    <div style="margin-top:12px">
      <button id="submitBtn" type="submit">Register</button>
      <span id="msg" role="status" aria-live="polite"></span>
    </div>
  </form>

  <div id="tokenPanel" class="hidden" style="margin-top:18px">
    <h3>Verification token</h3>
    <p class="muted">Send this token from your phone via WhatsApp to yourself (or copy it). After sending, paste the same token below to verify ownership.</p>
    <div class="tokenBox" id="tokenValue"></div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="copyToken" class="inline small" type="button">Copy</button>
      <button id="openWhatsApp" class="inline small" type="button">Open WhatsApp</button>
    </div>

    <div style="margin-top:12px">
      <label for="verify_token_input">Enter token you sent</label>
      <input id="verify_token_input" type="text" />
      <button id="verifyTokenBtn" style="margin-top:8px" type="button">Verify token</button>
      <div id="verifyMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(async function(){
  'use strict';

  const API_REGISTER = '/api/users/register_user.php';
  const API_VERIFY = '/api/users/verify_signed_token.php';
  const API_COUNTRIES = '/api/countries.php';
  const API_CITIES = '/api/cities.php?country_id=';

  // Form elements
  const form = document.getElementById('registerForm');
  const roleSelect = document.getElementById('role_key');
  const storeSection = document.getElementById('storeSection');
  const storeUseAccount = document.getElementById('store_use_account');
  const countrySelect = document.getElementById('country_id');
  const citySelect = document.getElementById('city_id');
  const storeCountrySelect = document.getElementById('store_country_id');
  const submitBtn = document.getElementById('submitBtn');
  const msgEl = document.getElementById('msg');

  // token panel
  const tokenPanel = document.getElementById('tokenPanel');
  const tokenValue = document.getElementById('tokenValue');
  const copyTokenBtn = document.getElementById('copyToken');
  const openWhatsappBtn = document.getElementById('openWhatsApp');
  const verifyTokenInput = document.getElementById('verify_token_input');
  const verifyTokenBtn = document.getElementById('verifyTokenBtn');
  const verifyMsg = document.getElementById('verifyMsg');

  const vendorRoles = ['vendor','home_vendor','third_party_service'];

  function setMsg(text, isError){
    msgEl.textContent = text || '';
    msgEl.className = isError ? 'error' : 'ok';
  }

  function toggleStore(){
    if (vendorRoles.indexOf(roleSelect.value) !== -1) storeSection.classList.remove('hidden');
    else storeSection.classList.add('hidden');
  }
  roleSelect.addEventListener('change', toggleStore);
  toggleStore();

  // load countries
  async function loadCountries(){
    try {
      const res = await fetch(API_COUNTRIES, { credentials:'include' });
      const json = await res.json();
      countrySelect.innerHTML = '<option value="">(select)</option>';
      storeCountrySelect.innerHTML = '<option value="">(select)</option>';
      if (json && json.success && Array.isArray(json.countries)) {
        json.countries.forEach(c => {
          const o = document.createElement('option'); o.value = c.id; o.textContent = c.name;
          countrySelect.appendChild(o);
          storeCountrySelect.appendChild(o.cloneNode(true));
        });
      } else {
        countrySelect.innerHTML = '<option value="">(error)</option>';
        storeCountrySelect.innerHTML = '<option value="">(error)</option>';
      }
    } catch(err){
      countrySelect.innerHTML = '<option value="">(error)</option>';
      storeCountrySelect.innerHTML = '<option value="">(error)</option>';
      console.error('loadCountries', err);
    }
  }

  async function loadCitiesFor(selectEl, countryId){
    selectEl.innerHTML = '<option value="">Loading...</option>';
    if (!countryId) { selectEl.innerHTML = '<option value="">Select country first</option>'; return; }
    try {
      const res = await fetch(API_CITIES + encodeURIComponent(countryId), { credentials:'include' });
      const json = await res.json();
      selectEl.innerHTML = '<option value="">(select)</option>';
      if (json && json.success && Array.isArray(json.cities)) {
        json.cities.forEach(c => {
          const o = document.createElement('option'); o.value = c.id; o.textContent = c.name;
          selectEl.appendChild(o);
        });
      } else {
        selectEl.innerHTML = '<option value="">(error)</option>';
      }
    } catch(err){
      selectEl.innerHTML = '<option value="">(error)</option>';
      console.error('loadCitiesFor', err);
    }
  }

  countrySelect.addEventListener('change', ()=> loadCitiesFor(citySelect, countrySelect.value));
  storeCountrySelect.addEventListener('change', ()=> loadCitiesFor(document.getElementById('store_city_id'), storeCountrySelect.value));
  loadCountries();

  storeUseAccount.addEventListener('change', function(){
    if (!this.checked) return;
    document.getElementById('store_email').value = document.getElementById('email').value || '';
    document.getElementById('store_phone').value = document.getElementById('phone').value || '';
    document.getElementById('store_country_id').value = document.getElementById('country_id').value || '';
    const userCountry = document.getElementById('country_id').value;
    if (userCountry) {
      loadCitiesFor(document.getElementById('store_city_id'), userCountry).then(()=> {
        document.getElementById('store_city_id').value = document.getElementById('city_id').value || '';
      });
    }
  });

  // helper to read response text if non-JSON
  async function readResponseText(response){
    try { return await response.text(); } catch(e){ return response.status + ' ' + response.statusText; }
  }

  form.addEventListener('submit', async function(e){
    e.preventDefault();
    setMsg('');
    submitBtn.disabled = true;

    const fd = new FormData();

    // user fields only (match users table)
    ['username','email','password','role_key','phone','preferred_language','country_id','city_id','timezone','postal_code'].forEach(k=>{
      const el = document.getElementsByName(k)[0];
      if (el && el.value !== undefined && el.value !== '') fd.set(k, el.value);
    });

    // store fields if requested
    if (document.getElementById('create_store') && document.getElementById('create_store').checked) {
      fd.set('create_store','1');
      if (storeUseAccount.checked) fd.set('store_use_account','1');
      ['store_name','store_email','store_phone','store_country_id','store_city_id','store_street_address','store_postal_code','store_state','store_latitude','store_longitude'].forEach(k=>{
        const el = document.getElementsByName(k)[0];
        if (el && el.value !== undefined && el.value !== '') fd.set(k, el.value);
      });
    }

    let res;
    try {
      res = await fetch(API_REGISTER, { method:'POST', body: fd, credentials:'include' });
    } catch (networkErr) {
      console.error('Network/Fetch error', networkErr);
      setMsg('Network error: ' + (networkErr.message || 'Failed to contact server'), true);
      submitBtn.disabled = false;
      return;
    }

    if (!res.ok) {
      const txt = await readResponseText(res);
      console.error('Server returned non-OK:', res.status, txt);
      setMsg('Server error: ' + res.status + ' — check console', true);
      submitBtn.disabled = false;
      return;
    }

    let json;
    try {
      json = await res.json();
    } catch (err) {
      const bodyText = await readResponseText(res);
      console.error('Invalid JSON from server', err, bodyText);
      setMsg('Unexpected server response — see console', true);
      submitBtn.disabled = false;
      return;
    }

    if (!json.success) {
      setMsg(json.message || 'Registration failed', true);
      submitBtn.disabled = false;
      return;
    }

    setMsg('Account created. Follow verification below.', false);

    if (json.token) {
      tokenValue.textContent = json.token;
      tokenPanel.classList.remove('hidden');

      openWhatsappBtn.onclick = function(){
        const textMsg = encodeURIComponent('Verification token: ' + json.token);
        window.open('https://wa.me/?text=' + textMsg, '_blank');
      };
      copyTokenBtn.onclick = function(){
        navigator.clipboard.writeText(json.token).then(()=> {
          copyTokenBtn.textContent = 'Copied';
          setTimeout(()=> copyTokenBtn.textContent = 'Copy', 1400);
        });
      };
    } else {
      setMsg(json.notice || 'Account created. No token returned.', false);
    }

    submitBtn.disabled = false;
  });

  // verify token
  verifyTokenBtn.addEventListener('click', async function(){
    const tok = verifyTokenInput.value.trim();
    const phone = document.getElementById('phone').value.trim();
    if (!tok) { verifyMsg.textContent = 'Please enter the token you sent.'; verifyMsg.className='error'; return; }
    verifyMsg.textContent = 'Verifying...'; verifyMsg.className='';
    try {
      const fd = new FormData();
      fd.set('token', tok);
      fd.set('phone', phone);
      const res = await fetch(API_VERIFY, { method:'POST', body: fd, credentials:'include' });
      const json = await res.json();
      if (json.success) {
        verifyMsg.textContent = 'Verification successful. Your account is active.'; verifyMsg.className='ok';
        setTimeout(()=> window.location.href = '/', 1200);
      } else {
        verifyMsg.textContent = json.message || 'Verification failed'; verifyMsg.className='error';
      }
    } catch (e) {
      console.error('verify error', e);
      verifyMsg.textContent = 'Network or server error'; verifyMsg.className='error';
    }
  });

})();
</script>
</body>
</html>